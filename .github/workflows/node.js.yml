name: Node.js CI & Release

on:
    push:
        branches: [ "master" ]
    pull_request:
        branches: [ "master" ]
    workflow_dispatch: # Manual execution enabled

jobs:
    # ----------------------------------------------------
    # 1. CI & Build Job
    # ----------------------------------------------------
    ci_build:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [18.x, 20.x, 22.x]

        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'
            - name: Install dependencies
              run: npm ci
            - name: Build plugin
              run: npm run build --if-present
        # [TODO: 여기에 'npm test' 명령을 추가하여 테스트를 실행해야 합니다.]

    # ----------------------------------------------------
    # 2. Release Job
    # ----------------------------------------------------
    release:
        # 'ci_build' 작업이 성공했을 때만 실행합니다.
        needs: ci_build

        # PR이 아닌, 'master' 브랜치에 직접 푸시되거나 병합되었을 때만 실행합니다.
        if: github.ref == 'refs/heads/master'

        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Use Node.js 20.x for Release
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: 'npm'

            # 의존성 설치
            - name: Install dependencies
              run: npm ci

            # 버전 정보 추출 (릴리스 생성 전에 위치 변경)
            - name: Get version from package.json
              id: get_version
              run: echo "PACKAGE_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

            # 최종 빌드 파일 생성 (main.js, styles.css 등)
            - name: Build plugin
              run: npm run build

            # 릴리스 생성 및 자산 첨부 (추출된 버전 사용)
            - name: Create Release and Upload Assets
              uses: softprops/action-gh-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  # env.PACKAGE_VERSION 사용
                  tag_name: v${{ env.PACKAGE_VERSION }}
                  name: Release v${{ env.PACKAGE_VERSION }}
                  draft: false
                  prerelease: false

                  # main.js, manifest.json, styles.css 파일을 자산으로 첨부
                  files: |
                      ./main.js
                      ./manifest.json
                      ./styles.css
